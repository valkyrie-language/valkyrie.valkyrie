name: Commit Lint

on:
  push:
    branches: [ master, dev ]
  pull_request:
    branches: [ master, dev ]

jobs:
  commit-lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile

    - name: Validate commit messages
      shell: bash
      env:
        LANG: en_US.UTF-8
        LC_ALL: en_US.UTF-8
      run: |
        export LANG=en_US.UTF-8
        export LC_ALL=en_US.UTF-8
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # å¯¹äºPRï¼Œæ£€æŸ¥æ‰€æœ‰æäº¤çš„commitæ¶ˆæ¯
          npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose --config scripts/commit-lint.config.js
        else
          # å¯¹äºpushï¼Œæ£€æŸ¥æœ€è¿‘çš„commit
          npx commitlint --from HEAD~1 --to HEAD --verbose --config scripts/commit-lint.config.js
        fi

    - name: Validate current commit
      if: always()
      shell: bash
      env:
        LANG: en_US.UTF-8
        LC_ALL: en_US.UTF-8
      run: |
        echo "Validating current commit message..."
        export LANG=en_US.UTF-8
        export LC_ALL=en_US.UTF-8
        git log -1 --pretty=format:"%s" | npx commitlint --verbose --config scripts/commit-lint.config.js

    - name: Check emoji format
      shell: bash
      env:
        LANG: en_US.UTF-8
        LC_ALL: en_US.UTF-8
      run: |
        echo "Checking emoji format in commit messages..."
        # è®¾ç½®UTF-8ç¼–ç 
        export LANG=en_US.UTF-8
        export LC_ALL=en_US.UTF-8
        
        # æ£€æŸ¥commitæ¶ˆæ¯æ˜¯å¦ç¬¦åˆemojiæ ¼å¼
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          COMMITS=$(git log --format="%s" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
        else
          COMMITS=$(git log -1 --pretty=format:"%s")
        fi
        
        # å®šä¹‰æ”¯æŒçš„emojiå­—ç¬¦
        SUPPORTED_EMOJIS="âœ¨ğŸ”§ğŸ“ğŸ¨â˜¢ï¸ğŸ§ªğŸ”¨âš¡ï¸ğŸš€ğŸ”–ğŸš¦ğŸ“¦âªğŸ’¡ğŸ§¨âœ…ğŸ”€ğŸ”®"
        
        echo "$COMMITS" | while IFS= read -r message; do
          if [ -n "$message" ]; then
            # è·å–æ¶ˆæ¯çš„ç¬¬ä¸€ä¸ªå­—ç¬¦
            FIRST_CHAR=$(echo "$message" | cut -c1-3)
            # æ£€æŸ¥æ˜¯å¦ä»¥æ”¯æŒçš„emojiå¼€å¤´
            if [[ ! "$SUPPORTED_EMOJIS" == *"$FIRST_CHAR"* ]]; then
              echo "âŒ é”™è¯¯: commitæ¶ˆæ¯å¿…é¡»ä»¥æ”¯æŒçš„emojiå¼€å¤´"
              echo "å½“å‰æ¶ˆæ¯: $message"
              echo "ç¬¬ä¸€ä¸ªå­—ç¬¦: $FIRST_CHAR"
              echo "æ”¯æŒçš„emojiç±»å‹:"
              echo "  âœ¨ feat: æ–°åŠŸèƒ½"
              echo "  ğŸ”§ fix: ä¿®å¤bug"
              echo "  ğŸ“ docs: æ–‡æ¡£æ›´æ–°"
              echo "  ğŸ¨ style: ä»£ç æ ¼å¼è°ƒæ•´"
              echo "  â˜¢ï¸ refactor: é‡æ„ä»£ç "
              echo "  ğŸ§ª test: æµ‹è¯•ç›¸å…³"
              echo "  ğŸ”¨ config: é…ç½®æ–‡ä»¶ä¿®æ”¹"
              echo "  âš¡ï¸ perf: æ€§èƒ½ä¼˜åŒ–"
              echo "  ğŸš€ release: å‘å¸ƒç‰ˆæœ¬"
              echo "  ğŸ”– tag: æ ‡ç­¾ç›¸å…³"
              echo "  ğŸš¦ ci: CI/CDç›¸å…³"
              echo "  ğŸ“¦ build: æ„å»ºç›¸å…³"
              echo "  âª revert: å›æ»šæ“ä½œ"
              echo "  ğŸ’¡ idea: æ–°æƒ³æ³•"
              echo "  ğŸ§¨ delete: åˆ é™¤æ–‡ä»¶"
              echo "  âœ… complete: å®Œæˆä»»åŠ¡"
              echo "  ğŸ”€ branch: åˆ†æ”¯æ“ä½œ"
              echo "  ğŸ”® experiment: å®éªŒæ€§åŠŸèƒ½"
              exit 1
            fi
          fi
        done
        echo "âœ… commitæ¶ˆæ¯æ ¼å¼æ­£ç¡®"